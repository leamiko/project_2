<include file="./Public/html/header.html" />
<div id="main">
    <div id="main-cnt">
        <div id="contentH" class="cnt-box wall" style="padding-left: 0px;">
            <div class="title clearfix">
                <div class="l title-cnt">
                    <span class="icon icon8"></span>Add a goods
                </div>
            </div>
        </div>
        <table cellpadding="0" cellspacing="0" class="l-table-edit">
            <tr>
                <td align="right" class="l-table-edit-td">
                    <span>*</span>Name:
                </td>
                <td align="left" class="l-table-edit-td">
                    <input type="text" id="name" />
                </td>
                <td align="left" class="tipmsg"></td>
            </tr>
            <tr>
                <td align="right" class="l-table-edit-td">
                    <span>*</span>Price:
                </td>
                <td align="left" class="l-table-edit-td">
                    <input type="text" id="price" />
                </td>
                <td align="left" class="tipmsg"></td>
            </tr>
            <tr>
                <td align="right" class="l-table-edit-td">
                    <span>*</span>Stock:
                </td>
                <td align="left" class="l-table-edit-td">
                    <input type="text" id="stock" />
                </td>
                <td align="left" class="tipmsg"></td>
            </tr>
            <tr>
                <td align="right" class="l-table-edit-td">
                    <span>*</span>Business Model:
                </td>
                <td align="left" class="l-table-edit-td">
                    <select id="business_model" style="width:80px;">
                        <option value="1">B2C</option>
                        <option value="2">B2B</option>
                    </select>
                </td>
                <td align="left" class="tipmsg"></td>
            </tr>
            <tr id="amount_select" style="display:none;">
                <td align="right" class="l-table-edit-td">
                    <span>*</span>Minimum sell:
                </td>
                <td align="left" class="l-table-edit-td">
                    <input type="text" id="sale_amount" />
                </td>
                <td align="left" class="tipmsg"></td>
            </tr>
            <tr>
                <td align="right" class="l-table-edit-td">
                    <span>*</span>Parent Category:
                </td>
                <td align="left" class="l-table-edit-td">
                    <select id="p_cate_id" style="width:160px;">
                        <option value="0">PARENT CATEGORY</option>
                        <volist name = "parent_category" id = "val">
                        <option value="<{$val['id']}>"><{$val['name']}></option>
                        </volist>
                    </select>
                </td>
                <td align="left" class="tipmsg"></td>
            </tr>
            <tr>
                <td align="right" class="l-table-edit-td">
                    <span>*</span>Child Category:
                </td>
                <td align="left" class="l-table-edit-td">
                    <select id="c_cate_id" style="width:160px;">
                    <option value="0">CHILD CATEGORY</option>
                    </select>
                </td>
                <td align="left" class="tipmsg"></td>
            </tr>
            <tr>
                <td align="right" class="l-table-edit-td">
                    <span>*</span>Unit:
                </td>
                <td align="left" class="l-table-edit-td">
                    <input type="text" id="unit" />
                </td>
                <td align="left" class="tipmsg"></td>
            </tr>
            <tr>
                <td align="right" class="l-table-edit-td">
                    <span>*</span>Shipping fee
                </td>
                <td align="left" class="l-table-edit-td">
                    <input type="text" id="shipping_fee" />
                </td>
                <td align="left" class="tipmsg"></td>
            </tr>
            <tr>
                <td align="right" class="l-table-edit-td">
                    Size:
                </td>
                <td align="left" class="l-table-edit-td">
                    <input type="text" id="size" />
                </td>
                <td align="left" class="tipmsg"></td>
            </tr>
            <tr>
                <td align="right" class="l-table-edit-td">
                    Weight:
                </td>
                <td align="left" class="l-table-edit-td">
                    <input type="text" id="weight" />
                </td>
                <td align="left" class="tipmsg"></td>
            </tr>
            <tr>
                <td align="right" class="l-table-edit-td">
                    Color:
                </td>
                <td align="left" class="l-table-edit-td">
                    <input type="text" id="color" />
                </td>
                <td align="left" class="tipmsg"></td>
            </tr>
            <tr>
                <td align="right" class="l-table-edit-td">
                    <span>*</span>Area:
                </td>
                <td align="left" class="l-table-edit-td">
                    <select id="area" style="width:160px;">
                        <option value="0">SELECT AN AREA</option>
                        <volist name = "area" id = "val">
                        <option value="<{$val['id']}>"><{$val['name_en']}></option>
                        </volist>
                    </select>
                </td>
                <td align="left" class="tipmsg"></td>
            </tr>
            <tr>
                <td align="right" class="l-table-edit-td">
                    Pay Method:
                </td>
                <td align="left" class="l-table-edit-td">
                    <select id="pay_method" style="width:80px;">
                        <option value="1">Paypal</option>
                    </select>
                </td>
                <td align="left" class="tipmsg"></td>
            </tr>
            <tr>
                <td align="right" class="l-table-edit-td">
                    Quality:
                </td>
                <td align="left" class="l-table-edit-td">
                    <textarea id="quality" style="resize: none;" onfocus="javascript:checkLength(this, 'quality_tip');" onkeydown="javascript:checkLength(this, 'quality_tip');" onkeyup="javascript:checkLength(this, 'quality_tip');" maxLength="80"></textarea>
                </td>
                <td align="left" class="tipmsg" id="quality_tip"></td>
            </tr>
            <tr>
                <td align="right" class="l-table-edit-td">
                    Guarantee:
                </td>
                <td align="left" class="l-table-edit-td">
                    <textarea id="guarantee" style="resize: none;" onfocus="javascript:checkLength(this, 'guarantee_tip');" onkeydown="javascript:checkLength(this, 'guarantee_tip');" onkeyup="javascript:checkLength(this, 'guarantee_tip');" maxLength="80"></textarea>
                </td>
                <td align="left" class="tipmsg" id="guarantee_tip"></td>
            </tr>
            <tr>
                <td align="right" class="l-table-edit-td">
                    Description:
                </td>
                <td align="left" class="l-table-edit-td">
                    <textarea id="desc" style="resize: none;" onfocus="javascript:checkLength(this, 'desc_tip');" onkeydown="javascript:checkLength(this, 'desc_tip');" onkeyup="javascript:checkLength(this, 'desc_tip');" maxLength="80"></textarea>
                </td>
                <td align="left" class="tipmsg" id="desc_tip"></td>
            </tr>
            <tr>
                <td align="right" class="l-table-edit-td">
                    <span>*</span>Goods Pictureï¼š
                </td>
                <td align="left" class="l-table-edit-td">
                    <span class="btn btn-success fileinput-button" style="color: #fff;">
                        &nbsp;&nbsp;Select
                        <input id="fileupload" type="file" name="files[]" multiple />
                    </span><br /><br />
                    <div id="progress" class="progress" style="display: none;">
                        <div class="progress-bar progress-bar-success"></div>
                    </div></td>
                <td align="left" class="tipmsg" id="image_tip"></td>
            </tr>
        </table>
    </div>
    <ul id="image_box">
    </ul>
    <div id="add_goods_button"><input class="btn btn-primary" type="button" value="Add" onclick="addGoodsSubmit();" /></div>
</div>
<style type="text/css">
<!--
body{font-size:12px}.l-table-edit-td{padding:10px 20px}.l-table-edit-td input{width:130px}.l-button-submit,.l-button-test{width:80px;float:left;margin-left:10px;padding-bottom:2px}.l-verify-tip{left:230px;top:120px}.l-table-edit tr td span{color:#f30;padding-left:5px}.tipmsg{color:#f30}#image_box{width:90%;clear:both;margin:12px auto}#image_box li{display:inline-block;position:relative;margin:6px 3px}#image_box li a img{width:160px;height:90px}.image-preview{position:relative;margin-top:16px}.image-preview-outter{display:block}.image-preview-delete{display:block;position:absolute;top:0;left:144px;background:url(/Public/images/delete.png) no-repeat;background-color:#fff;width:16px;height:16px}#add_goods_button{width:100%;text-align:center;margin:12px auto}@-webkit-keyframes progress-bar-stripes{from{background-position:40px 0}to{background-position:0 0}}@keyframes progress-bar-stripes{from{background-position:40px 0}to{background-position:0 0}}.progress{height:20px;margin-bottom:20px;overflow:hidden;background-color:#f5f5f5;border-radius:4px;-webkit-box-shadow:inset 0 1px 2px rgba(0,0,0,0.1);box-shadow:inset 0 1px 2px rgba(0,0,0,0.1)}.progress-bar{float:left;width:0;height:100%;font-size:12px;line-height:20px;color:#fff;text-align:center;background-color:#428bca;-webkit-box-shadow:inset 0 -1px 0 rgba(0,0,0,0.15);box-shadow:inset 0 -1px 0 rgba(0,0,0,0.15);-webkit-transition:width .6s ease;transition:width .6s ease}.progress-striped .progress-bar{background-image:-webkit-linear-gradient(45deg,rgba(255,255,255,0.15)25%,transparent 25%,transparent 50%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.15) 75%,transparent 75%,transparent);background-image:linear-gradient(45deg,rgba(255,255,255,0.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.15) 75%,transparent 75%,transparent);background-size:40px 40px}.progress.active .progress-bar{-webkit-animation:progress-bar-stripes 2s linear infinite;animation:progress-bar-stripes 2s linear infinite}.progress-bar-success{background-color:#5cb85c}.progress-striped .progress-bar-success{background-image:-webkit-linear-gradient(45deg,rgba(255,255,255,0.15)25%,transparent 25%,transparent 50%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.15) 75%,transparent 75%,transparent);background-image:linear-gradient(45deg,rgba(255,255,255,0.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.15) 75%,transparent 75%,transparent)}.progress-bar-info{background-color:#5bc0de}.progress-striped .progress-bar-info{background-image:-webkit-linear-gradient(45deg,rgba(255,255,255,0.15)25%,transparent 25%,transparent 50%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.15) 75%,transparent 75%,transparent);background-image:linear-gradient(45deg,rgba(255,255,255,0.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.15) 75%,transparent 75%,transparent)}.progress-bar-warning{background-color:#f0ad4e}.progress-striped .progress-bar-warning{background-image:-webkit-linear-gradient(45deg,rgba(255,255,255,0.15)25%,transparent 25%,transparent 50%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.15) 75%,transparent 75%,transparent);background-image:linear-gradient(45deg,rgba(255,255,255,0.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.15) 75%,transparent 75%,transparent)}.progress-bar-danger{background-color:#d9534f}.progress-striped .progress-bar-danger{background-image:-webkit-linear-gradient(45deg,rgba(255,255,255,0.15)25%,transparent 25%,transparent 50%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.15) 75%,transparent 75%,transparent);background-image:linear-gradient(45deg,rgba(255,255,255,0.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.15) 75%,transparent 75%,transparent)}
-->
</style>
<script type="text/javascript">
//<![CDATA[
var image_count = new Array();
$(function() {
    $("#name").blur(function() {
        removeTip($(this).parent('td').next('td:last'));
        ckName();
    });
    $("#business_model").change(function() {
        $("#c_cate_id").html('<option value="0">CHILD CATEGORY</option>');
        var business_model = parseInt($(this).val());
        if (business_model == 2) {
            $("#amount_select").show();
        } else {
            $("#amount_select").hide();
        }
        $.post('<{:U("Goods/getParentCategory")}>', {business_model: business_model}, function(data) {
            var str = '<option value="0">PARENT CATEGORY</option>';
            if (data) {
                for (var i in data) {
                    str += '<option value="' + data[i].id + '">' + data[i].name + '</option>';
                }
            }
            $("#p_cate_id").html(str);
        }, 'json');
    });
    $("#p_cate_id").change(function() {
        var p_cate_id = $(this).val();
        if (parseInt(p_cate_id) == 0) {
            addTip($(this).parent('td').next('td:last'), 'Please select a parent category for this goods.');
            $("#c_cate_id").html('<option value="0">CHILD CATEGORY</option>');
        } else {
            removeTip($(this).parent('td').next('td:last'));
            $.post('<{:U("Goods/getChildCategory")}>', {p_cate_id: p_cate_id}, function(data) {
                str = '<option value="0">CHILD CATEGORY</option>';
                if (data) {
                    for (var i in data) {
                        str += '<option value="' + data[i].id + '">' + data[i].name + '</option>';
                    }
                }
                $("#c_cate_id").html(str);
            }, 'json');
        }
    });
    $("#price").focus(function() {
        addTip($(this).parent('td').next('td:last'), 'Goods price with two decimal places at most');
    }).blur(function() {
        removeTip($(this).parent('td').next('td:last'));
        ckPrice();
    });
    $("#stock").blur(function() {
        removeTip($(this).parent('td').next('td:last'));
        ckStock();
    });
    $("#sale_amount").blur(function() {
        removeTip($(this).parent('td').next('td:last'));
        ckSaleAmount();
    });
    $("#unit").focus(function() {
        addTip($(this).parent('td').next('td:last'), 'Unit can not more than 30 characters.');
    }).blur(function() {
        removeTip($(this).parent('td').next('td:last'));
        ckUnit();
    });
    $("#shipping_fee").focus(function() {
        addTip($(this).parent('td').next('td:last'), 'Shipping fee with two decimal places at most');
    }).blur(function() {
        removeTip($(this).parent('td').next('td:last'));
        ckShippingFee();
    });
    $("#area").change(function() {
        removeTip($(this).parent('td').next('td:last'));
        ckArea();
    });
    $('#fileupload').fileupload({
        acceptFileTypes : /(\.|\/)(jpe?g|png)$/i,
        maxFileSize : 2097152,
        minFileSize : 1,
        url : '<{:U("Goods/upload")}>',
        dataType : 'json',
        submit : function(e, data) {
            var file =  data.files[0];
            if (file.size > 2097152) {
                $.ligerDialog.alert('file is too large, please upload another one.', 'Error(>_<)', 'warn');
                return false;
            }
            var reg = /jpe?g|png/i;
            if (!reg.test(file.type)) {
                $.ligerDialog.alert('Unsupported image format.', 'Error(>_<)', 'warn');
                return false;
            }
        },
        send : function(e, data) {
            $("#progress").show();
        },
        done : function(e, data) {
            if (data.result.status) {
                $("#progress").hide();
                image_count.push(data.result.filename);
                $("#image_box").append("<li>" +
                                       "<a href='" + data.result.src + "' target='_blank' title='Click to see the source' class='image-preview-outter'>" +
                                       "<img src='" + data.result.src + "' width='160' height='90' border='0' />" +
                                       "</a>" + 
                                       "<a href='javascript:void(0);' onclick=\"delete_image(\'" + data.result.filename + "\', $(this));\" class='image-preview-delete' title='Delete'>" +
                                       "</a>" + 
                                       "</li>");
            } else {
                $("#image_tip").html(data.result.msg);
            }
        },
        progressall : function(e, data) {
            var progress = parseInt(data.loaded / data.total * 100, 10);
            $('#progress .progress-bar').css('width', progress + '%');
        }
    });
});

//Add tips
function addTip(my, tip) {
    removeTip(my);
    var tip1 = '<div class="tip_msg">';
    var tip2 = '</div>';
    my.append(tip1 + tip + tip2);
}

//Remove tips
function removeTip(my) {
    my.find(".tip_msg").remove();
}

//Check goods name
function ckName() {
    var name = $.trim($("#name").val());
    if (name.length <= 0) {
        addTip($("#name").parent('td').next('td:last'), 'Goods name can not be empty.');
        return false;
    }
    return true;
}

//Check Parent Category
function ckParentCategory() {
    var p_cate_id = parseInt($("#p_cate_id").val());
    if (p_cate_id == 0) {
        addTip($("#p_cate_id").parent('td').next('td:last'), 'Please select a parent category for this goods.');
        return false;
    }
    return true;
}

//Check Child Category
function ckChildCategory() {
    var c_cate_id = parseInt($("#c_cate_id").val());
    if (c_cate_id == 0) {
        addTip($("#c_cate_id").parent('td').next('td:last'), 'Please select a child category for this goods.');
        return false;
    }
    return true;
}

//Check goods price
function ckPrice() {
    var price = $.trim($("#price").val());
    if (price.length <= 0) {
        addTip($("#price").parent('td').next('td:last'), 'Goods price can not be empty.');
        return false;
    }
    var priceReg = /^\d+(\.\d{1,2})?$/;
    if (!priceReg.test(price)) {
        addTip($("#price").parent('td').next('td:last'), 'Goods price with two decimal places at most and just contain number and decimal point.');
        return false;
    }
    if (parseFloat(price) > 9999999999.99) {
        addTip($("#price").parent('td').next('td:last'), 'Goods price is too high.');
        return false;
    }
    return true;
}

//Check stock
function ckStock() {
    var stock = $.trim($("#stock").val());
    if (stock.length == 0) {
        addTip($("#stock").parent('td').next('td:last'), 'Stock can not be empty.');
        return false;
    }
    if (stock.length > 11) {
        addTip($("#stock").parent('td').next('td:last'), 'Stock is too high.');
        return false;
    }
    var reg = /^\d+$/g;
    if (!reg.test(stock)) {
        addTip($("#stock").parent('td').next('td:last'), 'Stock just contains number only.');
        return false;
    }
    return true;
}

//Check Amount for sale
function ckSaleAmount() {
    var business_model = parseInt($("#business_model").val());
    if (business_model === 1) {
        return true;
    } else {
        var sale_amount = $.trim($("#sale_amount").val());
        if (sale_amount.length == 0) {
            addTip($("#sale_amount").parent('td').next('td:last'), 'The minimum sell can not be empty.');
            return false;
        }
        var reg = /^\d+$/g;
        if (!reg.test(sale_amount)) {
            addTip($("#sale_amount").parent('td').next('td:last'), 'Amount for sale just contains number only.');
            return false;
        }
        return true;
    }
}

//Check Unit
function ckUnit() {
    var unit = $.trim($("#unit").val());
    if (unit.length <= 0) {
        addTip($("#unit").parent('td').next('td:last'), 'Unit can not be empty.');
        return false;
    }
    if (unit.length > 30) {
        addTip($("#unit").parent('td').next('td:last'), 'Unit can not more than 30 characters.');
        return false;
    }
    return true;
}

//Check shipping fee
function ckShippingFee() {
    var shipping_fee = $.trim($("#shipping_fee").val());
    if (shipping_fee.length <= 0) {
        addTip($("#shipping_fee").parent('td').next('td:last'), 'Shipping fee can not be empty.');
        return false;
    }
    var sReg = /^\d+(\.\d{1,2})?$/;
    if (!sReg.test(shipping_fee)) {
        addTip($("#shipping_fee").parent('td').next('td:last'), 'Shipping fee with two decimal places at most and just contain number and decimal point.');
        return false;
    }
    if (parseFloat(shipping_fee) > 99999999.99) {
        addTip($("#shipping_fee").parent('td').next('td:last'), 'Shipping fee is too high.');
        return false;
    }
    return true;
}

//Check Area
function ckArea() {
    var area = $("#area").val();
    if (parseInt(area) == 0) {
        addTip($("#area").parent('td').next('td:last'), 'You must select an area for this goods.');
        return false;
    }
    return true;
}

//Check Length
function checkLength(obj, id) {
    var maxLength = obj.maxLength;
    var desc = obj.value;
    if (desc.length <= maxLength) {
        $("#"+id).html((maxLength - desc.length) + 'word(s) left');
    }
    obj.onblur = function() {
        $("#"+id).empty();
    }
}

//Check Images
function ckImage() {
    if (image_count.length <= 0) {
        addTip($("#image_tip"), 'Please upload one goods picture at least.');
        return false;
    }
    return true;
}

//Check Form
function checkForm() {
    if (!ckName()) return false;
    if (!ckParentCategory()) return false;
    if (!ckChildCategory()) return false;
    if (!ckPrice()) return false;
    if (!ckStock()) return false;
    if (!ckSaleAmount()) return false;
    if (!ckUnit()) return false;
    if (!ckShippingFee()) return false;
    if (!ckArea()) return false;
    if (!ckImage()) return false;
    var name = $.trim($("#name").val());
    var p_cate_id = parseInt($("#p_cate_id").val());
    var c_cate_id = parseInt($("#c_cate_id").val());
    var price = parseFloat($("#price").val());
    var stock = $.trim($("#stock").val());
    var business_model = parseInt($("#business_model").val());
    var sale_amount = $.trim($("#sale_amount").val());
    var unit = $.trim($("#unit").val());
    var shipping_fee = parseFloat($("#shipping_fee").val());
    var size = $.trim($("#size").val());
    var weight = $.trim($("#weight").val());
    var color = $.trim($("#color").val());
    var area = $("#area").val();
    var pay_method = parseInt($("#pay_method").val());
    var quality = $.trim($("#quality").val());
    var guarantee = $.trim($("#guarantee").val());
    var description = $.trim($("#desc").val());
    return {
        name: name,
        p_cate_id: p_cate_id,
        c_cate_id: c_cate_id,
        price: price,
        stock: stock,
        business_model: business_model,
        sale_amount: sale_amount,
        unit: unit,
        shipping_fee: shipping_fee,
        size: size,
        weight: weight,
        color: color,
        area: area,
        pay_method: pay_method,
        quality: quality,
        guarantee: guarantee,
        description: description,
        image: image_count
    };
}

//Submit Form
function addGoodsSubmit() {
    if (checkForm()) {
        $.post('<{:U("Goods/add")}>', checkForm(), function(data) {
            if (data.status) {
                $.ligerDialog.alert(data.msg, 'Success(^_^)', 'success');
                window.location.reload(true);
            } else {
                $.ligerDialog.alert(data.msg, 'Error(>_<)', 'error');
                return false;
            }
        }, 'json');
    }
}

//Delete Picture
function delete_image(filename, obj) {
    $.post('<{:U("Goods/delete_image")}>', {
        filename : filename
    }, function(data) {
        if (data.status) {
            obj.parent().remove();
            var index = image_count.indexOf(filename);
            image_count.splice(index, 1);
        } else {
            $.ligerDialog.alert(data.msg, 'Error(>_<)', 'error');
            return false;
        }
    }, 'json');
}

//]]>
</script>
<include file="./Public/html/footer.html" />