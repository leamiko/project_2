<include file="./Public/html/header.html" />
<div id="main">
    <div id="main-cnt">
        <div id="contentH" class="cnt-box wall" style="padding-left: 0px;">
            <div class="title clearfix">
                <div class="l title-cnt">
                    <span class="icon icon8"></span>Add an advertisement
                </div>
            </div>
        </div>
        <div class="top_6">
            <table cellpadding="10" cellspacing="10" class="tab">
                <tr height="60px">
                    <td align="right">Title:&nbsp;&nbsp;</td>
                    <td><input type="text" id="title" /></td>
                </tr>
                <tr height="60px">
                    <td align="right">Language:&nbsp;&nbsp;</td>
                    <td>
                        <input type="radio" value="1" name="language" />&nbsp;&nbsp;Chinese
                        <input type="radio" value="2" name="language" checked="checked" />&nbsp;&nbsp;English
                        <input type="radio" value="3" name="language" />&nbsp;&nbsp;Arabic
                    </td>
                </tr>
                <tr height="60px">
                    <td align="right">Business model:&nbsp;&nbsp;</td>
                    <td>
                        <select id="type">
                            <option value="1">Shop</option>
                            <option value="2">Factory</option>
                            <option value="3">Auction</option>
                            <option value="4">Sell&Buy</option>
                            <option value="5">Shipping</option>
                            <option value="6">Home</option>
                        </select>
                    </td>
                </tr>
                <tr height="60px">
                    <td align="right">Goods advertisement:&nbsp;&nbsp;</td>
                    <td>
                        <input type="radio" value="1" name="goods_advertisement" />&nbsp;&nbsp;Yes
                        <input type="radio" value="0" name="goods_advertisement" checked="checked" />&nbsp;&nbsp;No
                    </td>
                </tr>
                <tr height="60px" id="select_model" style="display:none;">
                    <td align="right">BUSINESS MODEL:&nbsp;&nbsp;</td>
                    <td>
                        <select id="business_model">
                            <option value="0">BUSINESS MODEL</option>
                            <option value="1">B2C</option>
                            <option value="2">B2B</option>
                        </select>
                    </td>
                </tr>
                <tr height="60px" id="select_parent" style="display:none;">
                    <td align="right">Parent Category:&nbsp;&nbsp;</td>
                    <td>
                        <select id="p_cate_id">
                        </select>
                    </td>
                </tr>
                <tr height="60px" id="select_child" style="display:none;">
                    <td align="right">Child Category:&nbsp;&nbsp;</td>
                    <td>
                        <select id="c_cate_id">
                        </select>
                    </td>
                </tr>
                <tr height="60px" id="select_goods" style="display:none;">
                    <td align="right">Goods:&nbsp;&nbsp;</td>
                    <td>
                        <select id="goods_id">
                        </select>
                    </td>
                </tr>
                <tr>
                    <td align="right">Content:&nbsp;&nbsp;</td>
                    <td><textarea id="content"></textarea></td>
                </tr>
                <tr>
                    <td align="right" class="l-table-edit-td">
                        Advertisement Pictureï¼š
                    </td>
                    <td align="left" class="l-table-edit-td">
                        <span class="btn btn-success fileinput-button" style="color: #fff;">
                            &nbsp;&nbsp;Select
                            <input id="fileupload" type="file" name="files[]" multiple />
                        </span><span class="tipmsg">&nbsp;&nbsp;Only can upload 6 pictures at most</span><br /><br />
                        <div id="progress" class="progress" style="display: none;">
                            <div class="progress-bar progress-bar-success"></div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td colspan="2">
                        <ul id="image_box">
                        </ul>
                    </td>
                </tr>
                <tr height="60px">
                    <td colspan="2" align="center"><input class="btn btn-primary" type="button" value="Save" onclick="saveAdvertisement()" /></td>
                </tr>
            </table>
        </div>
    </div>
</div>
<style type="text/css">
<!--
body{font-size:12px}.l-table-edit-td{padding:10px 20px}.l-table-edit-td input{width:130px}.l-button-submit,.l-button-test{width:80px;float:left;margin-left:10px;padding-bottom:2px}.l-verify-tip{left:230px;top:120px}.l-table-edit tr td span{color:#f30;padding-left:5px}.tipmsg{color:#f30}#image_box{width:90%;clear:both;margin:12px auto}#image_box li{display:inline-block;position:relative;margin:6px 3px}#image_box li a img{width:160px;height:90px}.image-preview{position:relative;margin-top:16px}.image-preview-outter{display:block}.image-preview-delete{display:block;position:absolute;top:0;left:144px;background:url(/Public/images/delete.png) no-repeat;background-color:#fff;width:16px;height:16px}#add_goods_button{width:100%;text-align:center;margin:12px auto}@-webkit-keyframes progress-bar-stripes{from{background-position:40px 0}to{background-position:0 0}}@keyframes progress-bar-stripes{from{background-position:40px 0}to{background-position:0 0}}.progress{height:20px;margin-bottom:20px;overflow:hidden;background-color:#f5f5f5;border-radius:4px;-webkit-box-shadow:inset 0 1px 2px rgba(0,0,0,0.1);box-shadow:inset 0 1px 2px rgba(0,0,0,0.1)}.progress-bar{float:left;width:0;height:100%;font-size:12px;line-height:20px;color:#fff;text-align:center;background-color:#428bca;-webkit-box-shadow:inset 0 -1px 0 rgba(0,0,0,0.15);box-shadow:inset 0 -1px 0 rgba(0,0,0,0.15);-webkit-transition:width .6s ease;transition:width .6s ease}.progress-striped .progress-bar{background-image:-webkit-linear-gradient(45deg,rgba(255,255,255,0.15)25%,transparent 25%,transparent 50%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.15) 75%,transparent 75%,transparent);background-image:linear-gradient(45deg,rgba(255,255,255,0.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.15) 75%,transparent 75%,transparent);background-size:40px 40px}.progress.active .progress-bar{-webkit-animation:progress-bar-stripes 2s linear infinite;animation:progress-bar-stripes 2s linear infinite}.progress-bar-success{background-color:#5cb85c}.progress-striped .progress-bar-success{background-image:-webkit-linear-gradient(45deg,rgba(255,255,255,0.15)25%,transparent 25%,transparent 50%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.15) 75%,transparent 75%,transparent);background-image:linear-gradient(45deg,rgba(255,255,255,0.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.15) 75%,transparent 75%,transparent)}.progress-bar-info{background-color:#5bc0de}.progress-striped .progress-bar-info{background-image:-webkit-linear-gradient(45deg,rgba(255,255,255,0.15)25%,transparent 25%,transparent 50%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.15) 75%,transparent 75%,transparent);background-image:linear-gradient(45deg,rgba(255,255,255,0.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.15) 75%,transparent 75%,transparent)}.progress-bar-warning{background-color:#f0ad4e}.progress-striped .progress-bar-warning{background-image:-webkit-linear-gradient(45deg,rgba(255,255,255,0.15)25%,transparent 25%,transparent 50%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.15) 75%,transparent 75%,transparent);background-image:linear-gradient(45deg,rgba(255,255,255,0.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.15) 75%,transparent 75%,transparent)}.progress-bar-danger{background-color:#d9534f}.progress-striped .progress-bar-danger{background-image:-webkit-linear-gradient(45deg,rgba(255,255,255,0.15)25%,transparent 25%,transparent 50%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.15) 75%,transparent 75%,transparent);background-image:linear-gradient(45deg,rgba(255,255,255,0.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.15) 75%,transparent 75%,transparent)}
-->
</style>
<script type="text/javascript" src="__PUBLIC__/ckeditor/ckeditor.js"></script>
<script type="text/javascript" src="__PUBLIC__/ckeditor/adapters/jquery.js"></script>
<script type="text/javascript">
//<![CDATA[
CKEDITOR.disableAutoInline = true;
var image_count = new Array();
$(function() {
    $("input[name='goods_advertisement']").change(function() {
        var is = parseInt($(this).val());
        if (is) {
            $("#select_model").show();
        } else {
            $("#select_model").hide();
            $("#select_parent").hide();
            $("#select_child").hide();
            $("#select_goods").hide();
        }
    });
    $("#business_model").change(function() {
        var business_model = parseInt($(this).val());
        if (business_model) {
            var parent_opt = '<option value="0">PARENT CATEGORY</option>';
            $.post('<{:U("advertisement/get_parent_list")}>', {business_model: business_model}, function(data) {
                for (var i in data) {
                    parent_opt += '<option value="' + data[i].id + '">' + data[i].name + '</option>';
                }
                $("#p_cate_id").html(parent_opt);
            }, 'json');
            $("#select_parent").show();
        } else {
            $("#select_parent").hide();
            $("#select_child").hide();
            $("#select_goods").hide();
        }
    });
    $("#p_cate_id").change(function() {
        var p_cate_id = parseInt($(this).val());
        if (p_cate_id) {
            var child_opt = '<option value="0">CHILD CATEGORY</option>';
            $.post('<{:U("advertisement/get_child_list")}>', {p_cate_id: p_cate_id}, function(data) {
                for (var i in data) {
                    child_opt += '<option value="' + data[i].id + '">' + data[i].name + '</option>';
                }
                $("#c_cate_id").html(child_opt);
            }, 'json');
            $("#select_child").show();
        } else {
            $("#select_child").hide();
            $("#select_goods").hide();
        }
    });
    $("#c_cate_id").change(function() {
        var c_cate_id = parseInt($(this).val());
        if (c_cate_id) {
            var goods_opt = '<option value="0">GOODS</option>';
            $.post('<{:U("advertisement/get_goods_list")}>', {c_cate_id: c_cate_id}, function(data) {
                for (var i in data) {
                    goods_opt += '<option value="' + data[i].id + '">' + data[i].name + '</option>';
                }
                $("#goods_id").html(goods_opt);
            }, 'json');
            $("#select_goods").show();
        } else {
            $("#select_goods").hide();
        }
    });
    var editor = $("#content").ckeditor({
        width         : 700,
        height        : 300,
        language      : 'en',
        filebrowserUploadUrl: '<{:U("advertisement/upload")}>'
    });
    $('#fileupload').fileupload({
        acceptFileTypes : /(\.|\/)(jpe?g|png)$/i,
        maxFileSize : 2097152,
        minFileSize : 1,
        url : '<{:U("advertisement/upload_advertisement_image")}>',
        dataType : 'json',
        submit : function(e, data) {
            if (image_count.length >= 6) {
                $.ligerDialog.alert('There are already have 6 pictures.', 'Error(>_<)', 'warn');
                return false;
            }
            var file =  data.files[0];
            if (file.size > 2097152) {
                $.ligerDialog.alert('file is too large, please upload another one.', 'Error(>_<)', 'warn');
                return false;
            }
            var reg = /jpe?g|png/i;
            if (!reg.test(file.type)) {
                $.ligerDialog.alert('Unsupported image format.', 'Error(>_<)', 'warn');
                return false;
            }
        },
        send : function(e, data) {
            $("#progress").show();
        },
        done : function(e, data) {
            if (data.result.status) {
                $("#progress").hide();
                if (image_count.length < 6) {
                    image_count.push(data.result.filename);
                    $("#image_box").append("<li>" +
                                           "<a href='" + data.result.src + "' target='_blank' title='Click to see the source' class='image-preview-outter'>" +
                                           "<img src='" + data.result.src + "' width='160' height='90' border='0' />" +
                                           "</a>" + 
                                           "<a href='javascript:void(0);' onclick=\"delete_image(\'" + data.result.filename + "\', $(this));\" class='image-preview-delete' title='Delete'>" +
                                           "</a>" + 
                                           "</li>");
                } else {
                    delete_another_image(data.result.filename);
                }
            } else {
                $.ligerDialog.alert(data.result.msg, 'Error(>_<)', 'warn');
            }
        },
        progressall : function(e, data) {
            var progress = parseInt(data.loaded / data.total * 100, 10);
            $('#progress .progress-bar').css('width', progress + '%');
        }
    });
});

//Check title
function ckTitle() {
    var title = $.trim($("#title").val());
    if (title.length <= 0) {
        $.ligerDialog.alert('Advertisement title can not be empty.', 'Error(>_<)', 'warn');
        return false;
    }
    return true;
}

//Check goods
function ckGoods() {
    var is = parseInt($("input[name='goods_advertisement']").filter(":checked").val());
    if (is) {
        var business_model = parseInt($("#business_model").val());
        var p_cate_id = parseInt($("#p_cate_id").val());
        var c_cate_id = parseInt($("#c_cate_id").val());
        var goods_id = parseInt($("#goods_id").val());
        if (!business_model || !p_cate_id || !goods_id || !c_cate_id) {
            $.ligerDialog.alert('Please select a goods', 'Error(>_<)', 'warn');
            return false;
        }
    }
    return true;
}

//Check content
function ckContent() {
    var content = $.trim($("#content").val());
    if (content.length <= 0) {
        $.ligerDialog.alert('Advertisement content can not be empty.', 'Error(>_<)', 'warn');
        return false;
    }
    return true;
}

//Check Images
function ckImage() {
    if (image_count.length <= 0) {
        $.ligerDialog.alert('Please upload one advertisement picture at least.', 'Error(>_<)', 'warn');
        return false;
    }
    return true;
}

// Save advertisement
function saveAdvertisement() {
    if (!ckTitle()) return false;
    if (!ckGoods()) return false;
    if (!ckContent()) return false;
    if (!ckImage()) return false;
    var title = $.trim($("#title").val());
    var language = $("input[name='language']").filter(":checked").val();
    var type = $("#type").val();
    var is_goods_advertisement = $("input[name='goods_advertisement']").filter(":checked").val();
    var business_model = parseInt(is_goods_advertisement) ? $("#business_model").val() : '';
    var p_cate_id = parseInt(is_goods_advertisement) ? $("#p_cate_id").val() : '';
    var c_cate_id = parseInt(is_goods_advertisement) ? $("#c_cate_id").val() : '';
    var goods_id = parseInt(is_goods_advertisement) ? $("#goods_id").val() : '';
    var content = $.trim($("#content").val());
    var post_data = {
            title: title,
            language: language,
            type: type,
            is_goods_advertisement: is_goods_advertisement,
            business_model: business_model,
            p_cate_id: p_cate_id,
            c_cate_id: c_cate_id,
            goods_id: goods_id,
            content: content,
            image: image_count
    };
    $.post("<{:U('advertisement/add')}>", post_data, function(data) {
        if (data.status) {
            $.ligerDialog.alert(data.msg, 'Success(^_^)', 'success');
            window.location.reload(true);
        } else {
            $.ligerDialog.alert(data.msg, 'Error(>_<)', 'error');
            return false;
        }
    }, 'json');
}

//Delete image
function delete_image(filename, obj) {
    $.post('<{:U("advertisement/delete_image")}>', {
        filename : filename
    }, function(data) {
        if (data.status) {
            obj.parent().remove();
            var index = image_count.indexOf(filename);
            image_count.splice(index, 1);
        } else {
            $.ligerDialog.alert(data.msg, 'Error(>_<)', 'error');
            return false;
        }
    }, 'json');
}

//Delete excess image
function delete_another_image(filename) {
    $.post('<{:U("advertisement/delete_image")}>', {
        filename: filename
    });
}
//]]>
</script>
<include file="./Public/html/footer.html" />